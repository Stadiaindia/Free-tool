<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Talent Scout - Free for Indian Coaches üáÆüá≥</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0f172a;
            color: #fff;
            min-height: 100vh;
        }
        .header {
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            padding: 24px 20px;
            text-align: center;
            position: relative;
        }
        .header h1 { font-size: 28px; margin-bottom: 8px; font-weight: 900; }
        .header p { font-size: 14px; opacity: 0.9; }
        .container { max-width: 500px; margin: 0 auto; padding: 20px; }
        .card {
            background: #1e293b;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
        }
        .input, .select {
            width: 100%;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 10px;
            padding: 12px 14px;
            font-size: 15px;
            color: #fff;
            outline: none;
            margin-top: 8px;
        }
        .label {
            display: block;
            font-size: 12px;
            font-weight: 700;
            color: #94a3b8;
            text-transform: uppercase;
            margin-top: 14px;
        }
        .label:first-child { margin-top: 0; }
        .btn {
            width: 100%;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: #fff;
            border: none;
            border-radius: 12px;
            padding: 14px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 10px;
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-secondary { background: #334155; }
        .btn-success { background: #10b981; }
        .score-circle {
            font-size: 56px;
            font-weight: 900;
            text-align: center;
            margin: 20px 0;
        }
        .athlete-item {
            display: flex;
            align-items: center;
            gap: 14px;
            background: #1e293b;
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .athlete-item:hover { border-color: #3b82f6; }
        .athlete-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        .athlete-info { flex: 1; }
        .athlete-name { font-weight: 700; font-size: 15px; margin-bottom: 4px; }
        .athlete-details { font-size: 13px; color: #94a3b8; }
        .athlete-score { text-align: right; }
        .athlete-score-num { font-size: 24px; font-weight: 900; }
        .athlete-score-label { font-size: 11px; font-weight: 700; }
        .bar-container { background: #0f172a; height: 8px; border-radius: 4px; overflow: hidden; margin: 6px 0; }
        .bar { height: 100%; border-radius: 4px; transition: width 0.3s; }
        .metric-item { margin-bottom: 16px; }
        .metric-header { display: flex; justify-content: space-between; margin-bottom: 6px; }
        .metric-name { font-size: 14px; font-weight: 600; }
        .metric-score { font-size: 14px; font-weight: 700; }
        .metric-detail { font-size: 12px; color: #64748b; margin-top: 4px; }
        .profile-card {
            display: flex;
            align-items: center;
            gap: 12px;
            background: #1e293b;
            border: 2px solid #3b82f6;
            padding: 16px;
            border-radius: 16px;
            margin-bottom: 16px;
        }
        .profile-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #3b82f6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        .profile-name { font-weight: 700; font-size: 15px; margin-bottom: 2px; }
        .profile-school { font-size: 13px; color: #94a3b8; margin-bottom: 2px; }
        .profile-location { font-size: 12px; color: #64748b; }
        .stats-box {
            text-align: center;
            background: #1e293b;
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 16px;
        }
        .stats-number { font-size: 48px; font-weight: 900; color: #3b82f6; }
        .stats-label { font-size: 14px; color: #94a3b8; }
        .back-btn {
            background: none;
            border: none;
            color: #fff;
            font-size: 20px;
            cursor: pointer;
            position: absolute;
            left: 20px;
            top: 24px;
        }
        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: #fff;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 12px;
            cursor: pointer;
            font-weight: 600;
            position: absolute;
            right: 20px;
            top: 24px;
        }
        .referral-card {
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            border: 2px solid #60a5fa;
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 16px;
        }
        .referral-title { font-size: 16px; margin-bottom: 8px; font-weight: 700; }
        .referral-text { font-size: 14px; opacity: 0.9; line-height: 1.6; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .privacy-note {
            background: #1e293b;
            border: 2px solid #334155;
            padding: 16px;
            border-radius: 16px;
            margin-top: 20px;
        }
        .privacy-title { font-size: 14px; color: #94a3b8; margin-bottom: 8px; font-weight: 700; }
        .privacy-text { font-size: 13px; color: #64748b; line-height: 1.6; }
        .sport-option {
            background: #0f172a;
            border: 2px solid #334155;
            padding: 16px;
            border-radius: 12px;
            cursor: pointer;
            margin-bottom: 10px;
            text-align: center;
            transition: all 0.2s;
        }
        .sport-option.selected {
            border-color: #3b82f6;
            background: #1e40af20;
        }
        .sport-icon { font-size: 32px; margin-bottom: 8px; }
        .sport-name { font-weight: 700; font-size: 15px; }
        .comparison-card {
            background: #0f172a;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 12px;
        }
        .comparison-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #334155;
        }
        .comparison-date { font-size: 13px; color: #94a3b8; }
        .comparison-score { font-size: 24px; font-weight: 900; }
        .trend-up { color: #10b981; }
        .trend-down { color: #ef4444; }
        .trend-same { color: #94a3b8; }
        .share-banner {
            background: linear-gradient(135deg, #10b981, #059669);
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 16px;
        }
        .share-text { font-size: 13px; margin-bottom: 10px; line-height: 1.5; }
        .share-link { 
            background: rgba(255,255,255,0.2);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 700;
            word-break: break-all;
            margin-top: 8px;
            display: inline-block;
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // Indian States
        const STATES = [
            "Andhra Pradesh", "Arunachal Pradesh", "Assam", "Bihar", "Chhattisgarh",
            "Goa", "Gujarat", "Haryana", "Himachal Pradesh", "Jharkhand",
            "Karnataka", "Kerala", "Madhya Pradesh", "Maharashtra", "Manipur",
            "Meghalaya", "Mizoram", "Nagaland", "Odisha", "Punjab",
            "Rajasthan", "Sikkim", "Tamil Nadu", "Telangana", "Tripura",
            "Uttar Pradesh", "Uttarakhand", "West Bengal",
            "Andaman & Nicobar", "Chandigarh", "Dadra & Nagar Haveli", "Daman & Diu",
            "Delhi", "Jammu & Kashmir", "Ladakh", "Lakshadweep", "Puducherry"
        ].sort();

        // Sports configurations
        const SPORTS = {
            "Track Athlete": {
                metrics: {
                    sprint50: { name: "50m Sprint", unit: "seconds", icon: "‚ö°", lower_better: true },
                    standingJump: { name: "Standing Broad Jump", unit: "cm", icon: "ü¶ò", lower_better: false },
                    shuttle: { name: "4x10m Shuttle Run", unit: "seconds", icon: "üîÑ", lower_better: true },
                    flexibility: { name: "Sit & Reach", unit: "cm", icon: "ü§∏", lower_better: false }
                },
                weights: { sprint50: 30, standingJump: 30, shuttle: 25, flexibility: 15 },
                benchmarks: {
                    "10": { sprint50: 9.5, standingJump: 110, shuttle: 14.5, flexibility: 15 },
                    "12": { sprint50: 8.8, standingJump: 130, shuttle: 13.5, flexibility: 18 },
                    "14": { sprint50: 8.0, standingJump: 150, shuttle: 12.5, flexibility: 20 },
                    "16": { sprint50: 7.3, standingJump: 170, shuttle: 11.5, flexibility: 22 },
                    "18": { sprint50: 6.8, standingJump: 190, shuttle: 10.8, flexibility: 25 }
                }
            },
            "Football": {
                metrics: {
                    sprint30: { name: "30m Sprint", unit: "seconds", icon: "‚ö°", lower_better: true },
                    agilityT: { name: "T-Test Agility", unit: "seconds", icon: "üîÑ", lower_better: true },
                    verticalJump: { name: "Vertical Jump", unit: "cm", icon: "ü¶ò", lower_better: false },
                    yo_yo: { name: "Yo-Yo Test Level", unit: "level", icon: "ü´Å", lower_better: false }
                },
                weights: { sprint30: 25, agilityT: 30, verticalJump: 20, yo_yo: 25 },
                benchmarks: {
                    "10": { sprint30: 6.2, agilityT: 14.0, verticalJump: 20, yo_yo: 8 },
                    "12": { sprint30: 5.7, agilityT: 13.0, verticalJump: 25, yo_yo: 10 },
                    "14": { sprint30: 5.2, agilityT: 12.0, verticalJump: 30, yo_yo: 12 },
                    "16": { sprint30: 4.8, agilityT: 11.0, verticalJump: 35, yo_yo: 14 },
                    "18": { sprint30: 4.5, agilityT: 10.5, verticalJump: 40, yo_yo: 16 }
                }
            }
        };

        const AGE_GROUPS = ["10", "12", "14", "16", "18"];

        // State
        let state = {
            view: 'welcome',
            coach: null,
            athletes: [],
            currentAthlete: null,
            comparisonData: null,
            form: { name: '', age: '12', sport: 'Track Athlete', values: {} }
        };

        // Load data
        function loadData() {
            const savedCoach = localStorage.getItem('talentScout_coach');
            if (savedCoach) {
                state.coach = JSON.parse(savedCoach);
                const savedAthletes = localStorage.getItem(`talentScout_athletes_${state.coach.phone}`);
                if (savedAthletes) {
                    state.athletes = JSON.parse(savedAthletes);
                }
                state.view = 'home';
            }
        }

        function saveCoach(coach) {
            localStorage.setItem('talentScout_coach', JSON.stringify(coach));
            const allCoaches = JSON.parse(localStorage.getItem('talentScout_allCoaches') || '{}');
            allCoaches[coach.phone] = coach;
            localStorage.setItem('talentScout_allCoaches', JSON.stringify(allCoaches));
            state.coach = coach;
        }

        function saveAthletes() {
            if (state.coach) {
                localStorage.setItem(`talentScout_athletes_${state.coach.phone}`, JSON.stringify(state.athletes));
            }
        }

        // Calculate score
        function calcScore(athlete) {
            const sportConfig = SPORTS[athlete.sport];
            const bench = sportConfig.benchmarks[athlete.age];
            const weights = sportConfig.weights;
            const metrics = Object.keys(sportConfig.metrics);
            
            const scores = metrics.map(m => {
                const val = parseFloat(athlete.values[m]);
                const b = bench[m];
                const metricInfo = sportConfig.metrics[m];
                
                let pct;
                if (metricInfo.lower_better) {
                    pct = Math.min(120, (b / val) * 100);
                } else {
                    pct = Math.min(120, (val / b) * 100);
                }
                
                return { 
                    metric: m, 
                    name: metricInfo.name,
                    score: Math.round(pct), 
                    raw: val, 
                    bench: b,
                    unit: metricInfo.unit,
                    icon: metricInfo.icon
                };
            });

            const total = Math.min(100, Math.round(
                scores.reduce((acc, s) => acc + (s.score * weights[s.metric]) / 100, 0)
            ));

            return { total, scores };
        }

        function getRating(score) {
            if (score >= 85) return { label: "Elite", color: "#10B981", emoji: "üî•" };
            if (score >= 70) return { label: "High Potential", color: "#3B82F6", emoji: "‚≠ê" };
            if (score >= 55) return { label: "Promising", color: "#F59E0B", emoji: "üëç" };
            return { label: "Developing", color: "#8B5CF6", emoji: "üå±" };
        }

        // Get athlete history
        function getAthleteHistory(athleteName, sport) {
            return state.athletes
                .filter(a => a.name.toLowerCase() === athleteName.toLowerCase() && a.sport === sport)
                .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
        }

        // Export CSV
        function exportCSV() {
            const headers = ["Coach", "Phone", "School", "District", "State", "Athlete", "Age", "Sport"];
            const firstAthlete = state.athletes[0];
            if (firstAthlete) {
                Object.keys(SPORTS[firstAthlete.sport].metrics).forEach(m => {
                    headers.push(SPORTS[firstAthlete.sport].metrics[m].name);
                });
            }
            headers.push("Score", "Rating", "Date", "Time");

            const rows = [headers];
            
            state.athletes.forEach(a => {
                const metricValues = Object.keys(SPORTS[a.sport].metrics).map(m => a.values[m]);
                const dateTime = new Date(a.timestamp);
                rows.push([
                    state.coach.name, state.coach.phone, state.coach.school, 
                    state.coach.district, state.coach.state,
                    a.name, a.age, a.sport, ...metricValues,
                    a.total, getRating(a.total).label, 
                    dateTime.toLocaleDateString('en-IN'),
                    dateTime.toLocaleTimeString('en-IN')
                ]);
            });

            const csv = rows.map(r => r.join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `TalentScout_${state.coach.name.replace(/\s/g, '_')}_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // Render functions
        function render() {
            const app = document.getElementById('app');
            
            if (state.view === 'welcome') app.innerHTML = renderWelcome();
            else if (state.view === 'login') app.innerHTML = renderLogin();
            else if (state.view === 'home') app.innerHTML = renderHome();
            else if (state.view === 'assess') app.innerHTML = renderAssess();
            else if (state.view === 'result') app.innerHTML = renderResult();
            else if (state.view === 'list') app.innerHTML = renderList();
            else if (state.view === 'compare') app.innerHTML = renderCompare();

            attachEventListeners();
        }

        function renderWelcome() {
            return `
                <div class="header">
                    <h1>üèÉ Talent Scout</h1>
                    <p>Free for all coaches ‚Ä¢ Made in India üáÆüá≥</p>
                </div>
                <div class="container">
                    <div class="share-banner">
                        <p class="share-text">
                            <strong>üéØ FREE FOREVER</strong><br>
                            Used by 500+ coaches across India<br>
                            Share with your PE teacher friends!
                        </p>
                    </div>

                    <div class="card">
                        <h2 style="font-size: 20px; text-align: center; margin-bottom: 12px;">üëã Welcome Coach!</h2>
                        <p style="font-size: 14px; color: #cbd5e1; text-align: center; line-height: 1.6; margin-bottom: 20px;">
                            Login with your phone number. First time? We'll set up your profile in 30 seconds!
                        </p>

                        <label class="label">Your Full Name</label>
                        <input class="input" id="coach-name" placeholder="e.g. Rajesh Kumar">

                        <label class="label">Mobile Number (Your Login ID)</label>
                        <input class="input" id="coach-phone" type="tel" placeholder="10-digit number" maxlength="10">

                        <button class="btn" id="check-phone-btn" style="margin-top: 20px;">Continue ‚Üí</button>
                    </div>

                    <div class="privacy-note">
                        <h3 class="privacy-title">üîí Privacy & Data</h3>
                        <p class="privacy-text">
                            Your phone is your login. Data stays on YOUR device only. Use same phone to login anytime.
                        </p>
                    </div>
                </div>
            `;
        }

        function renderLogin() {
            return `
                <div class="header" style="position: relative;">
                    <button class="back-btn" id="back-to-welcome-btn">‚Üê</button>
                    <h1 style="font-size: 22px;">Complete Your Profile</h1>
                </div>
                <div class="container">
                    <div class="card">
                        <label class="label">Your Full Name *</label>
                        <input class="input" id="coach-name" placeholder="e.g. Rajesh Kumar" value="${state.setupForm.name || ''}">

                        <label class="label">Mobile Number (Cannot change)</label>
                        <input class="input" id="coach-phone" type="tel" value="${state.setupForm.phone}" disabled style="opacity: 0.6;">

                        <label class="label">School/Institution *</label>
                        <input class="input" id="coach-school" placeholder="e.g. Government High School">

                        <label class="label">District *</label>
                        <input class="input" id="coach-district" placeholder="e.g. Mumbai">

                        <label class="label">State / UT *</label>
                        <select class="select" id="coach-state">
                            <option value="">Select State</option>
                            ${STATES.map(s => `<option value="${s}">${s}</option>`).join('')}
                        </select>

                        <button class="btn" id="setup-btn" style="margin-top: 20px;">Start Using Talent Scout ‚Üí</button>
                    </div>
                </div>
            `;
        }

        function renderHome() {
            const totalTests = state.athletes.length;
            const uniqueAthletes = [...new Set(state.athletes.map(a => a.name.toLowerCase()))].length;

            return `
                <div class="header" style="position: relative;">
                    <button class="logout-btn" id="logout-btn">Logout</button>
                    <h1 style="font-size: 22px; margin-bottom: 4px;">üèÉ Talent Scout</h1>
                    <p style="font-size: 13px; opacity: 0.8;">${state.coach.name}</p>
                </div>
                <div class="container">
                    <div class="profile-card">
                        <div class="profile-icon">üë§</div>
                        <div style="flex: 1;">
                            <p class="profile-name">${state.coach.name}</p>
                            <p class="profile-school">${state.coach.school}</p>
                            <p class="profile-location">üìç ${state.coach.district}, ${state.coach.state}</p>
                        </div>
                    </div>

                    <div class="grid-2">
                        <div class="stats-box">
                            <div class="stats-number">${uniqueAthletes}</div>
                            <p class="stats-label">Athletes</p>
                        </div>
                        <div class="stats-box">
                            <div class="stats-number">${totalTests}</div>
                            <p class="stats-label">Total Tests</p>
                        </div>
                    </div>

                    ${totalTests === 0 ? `
                        <div class="card">
                            <h3 style="font-size: 16px; margin-bottom: 12px;">üéØ Quick Start</h3>
                            <p style="font-size: 14px; color: #cbd5e1; margin-bottom: 16px; line-height: 1.6;">
                                1. Click "New Assessment"<br>
                                2. Choose sport (Track or Football)<br>
                                3. Run 4 simple tests<br>
                                4. Get instant talent score!
                            </p>
                        </div>
                    ` : ''}

                    <button class="btn" id="new-assessment-btn">+ New Assessment</button>
                    
                    ${totalTests > 0 ? `
                        <button class="btn btn-secondary" id="view-all-btn">üìä View All Tests (${totalTests})</button>
                        <button class="btn btn-success" id="export-btn">üì• Export to Excel</button>
                    ` : ''}

                    <div class="share-banner" style="margin-top: 20px;">
                        <p class="share-text">
                            <strong>üíö Love this tool?</strong><br>
                            Share with other coaches!<br>
                            100% Free ‚Ä¢ No Ads ‚Ä¢ Made for India
                        </p>
                    </div>
                </div>
            `;
        }

        function renderAssess() {
            const sportConfig = SPORTS[state.form.sport];
            const metrics = sportConfig.metrics;
            const benchmarks = sportConfig.benchmarks[state.form.age];

            return `
                <div class="header" style="position: relative;">
                    <button class="back-btn" id="back-btn">‚Üê</button>
                    <h1 style="font-size: 22px;">New Assessment</h1>
                </div>
                <div class="container">
                    <div class="card">
                        <label class="label">Athlete Name *</label>
                        <input class="input" id="athlete-name" placeholder="Full name" value="${state.form.name}">
                        <p style="font-size: 11px; color: #64748b; margin-top: 4px;">
                            üí° Same name? We'll track progress over time!
                        </p>

                        <label class="label">Age *</label>
                        <select class="select" id="athlete-age">
                            ${AGE_GROUPS.map(a => 
                                `<option ${state.form.age === a ? 'selected' : ''}>${a} years</option>`
                            ).join('')}
                        </select>

                        <label class="label">Sport *</label>
                        <div style="margin-top: 12px;">
                            ${Object.keys(SPORTS).map(s => `
                                <div class="sport-option ${state.form.sport === s ? 'selected' : ''}" data-sport="${s}">
                                    <div class="sport-icon">${s === 'Track Athlete' ? 'üèÉ‚Äç‚ôÇÔ∏è' : '‚öΩ'}</div>
                                    <div class="sport-name">${s}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="card">
                        <h3 style="font-size: 16px; margin-bottom: 4px;">üìä Test Results</h3>
                        <p style="font-size: 12px; color: #64748b; margin-bottom: 16px;">
                            ${state.form.sport} ‚Ä¢ Age ${state.form.age} benchmarks
                        </p>
                        
                        ${Object.entries(metrics).map(([key, metric]) => `
                            <label class="label">${metric.icon} ${metric.name}</label>
                            <input class="input metric-input" id="metric-${key}" type="number" step="0.1" 
                                placeholder="Target: ${benchmarks[key]} ${metric.unit}" 
                                value="${state.form.values[key] || ''}">
                        `).join('')}
                    </div>

                    <button class="btn" id="calculate-btn">Calculate Score üéØ</button>
                </div>
            `;
        }

        function renderResult() {
            const a = state.currentAthlete;
            const { label, color, emoji } = getRating(a.total);
            const history = getAthleteHistory(a.name, a.sport);
            const hasHistory = history.length > 1;

            return `
                <div style="background: linear-gradient(135deg, ${color}, ${color}dd); padding: 32px 20px; text-align: center;">
                    <h1 style="font-size: 24px; margin-bottom: 8px;">${a.name}</h1>
                    <p style="font-size: 14px; opacity: 0.9; margin-bottom: 20px;">${a.sport} ‚Ä¢ ${a.age} years old</p>
                    <div class="score-circle">${a.total}</div>
                    <div style="font-size: 18px; font-weight: 700;">${emoji} ${label}</div>
                    ${hasHistory ? `<p style="font-size: 12px; opacity: 0.8; margin-top: 8px;">üìà ${history.length} tests recorded</p>` : ''}
                </div>

                <div class="container">
                    ${hasHistory ? `
                        <button class="btn btn-success" id="view-progress-btn" style="margin-bottom: 16px;">
                            üìà View Progress Report
                        </button>
                    ` : ''}

                    <div class="card">
                        <h3 style="font-size: 16px; margin-bottom: 16px;">Performance Breakdown</h3>
                        ${a.scores.map(s => {
                            const barColor = s.score >= 85 ? '#10b981' : s.score >= 70 ? '#3b82f6' : s.score >= 55 ? '#f59e0b' : '#8b5cf6';
                            return `
                                <div class="metric-item">
                                    <div class="metric-header">
                                        <span class="metric-name">${s.icon} ${s.name}</span>
                                        <span class="metric-score" style="color: ${barColor};">${s.score}/100</span>
                                    </div>
                                    <div class="bar-container">
                                        <div class="bar" style="width: ${s.score}%; background: ${barColor};"></div>
                                    </div>
                                    <p class="metric-detail">Result: ${s.raw} ${s.unit} ‚Ä¢ Target: ${s.bench} ${s.unit}</p>
                                </div>
                            `;
                        }).join('')}
                    </div>

                    ${a.total >= 70 ? `
                        <div class="referral-card">
                            <h3 class="referral-title">üéØ District/State Referral Ready!</h3>
                            <p class="referral-text">
                                ${a.name} qualifies for advanced training programs. Export data and submit to your sports authority.
                            </p>
                        </div>
                    ` : ''}

                    <div class="grid-2">
                        <button class="btn btn-secondary" id="new-test-btn">New Test</button>
                        <button class="btn" id="view-all-from-result-btn">All Tests</button>
                    </div>
                </div>
            `;
        }

        function renderList() {
            const grouped = {};
            state.athletes.forEach(a => {
                const key = `${a.name.toLowerCase()}_${a.sport}`;
                if (!grouped[key]) grouped[key] = [];
                grouped[key].push(a);
            });

            return `
                <div class="header" style="position: relative;">
                    <button class="back-btn" id="back-btn">‚Üê</button>
                    <h1 style="font-size: 22px;">All Tests (${state.athletes.length})</h1>
                </div>
                <div class="container">
                    ${Object.values(grouped).map(group => {
                        const latest = group[group.length - 1];
                        const { label, color, emoji } = getRating(latest.total);
                        return `
                            <div class="athlete-item" data-id="${latest.id}">
                                <div class="athlete-icon" style="background: ${color}20;">${emoji}</div>
                                <div class="athlete-info">
                                    <p class="athlete-name">${latest.name}</p>
                                    <p class="athlete-details">${latest.sport} ‚Ä¢ ${latest.age}y ‚Ä¢ ${group.length} test${group.length > 1 ? 's' : ''}</p>
                                </div>
                                <div class="athlete-score">
                                    <div class="athlete-score-num" style="color: ${color};">${latest.total}</div>
                                    <div class="athlete-score-label" style="color: ${color};">${label}</div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function renderCompare() {
            const history = state.comparisonData;
            if (!history || history.length === 0) return renderHome();

            const latest = history[history.length - 1];
            const oldest = history[0];
            const improvement = latest.total - oldest.total;

            return `
                <div class="header" style="position: relative;">
                    <button class="back-btn" id="back-btn">‚Üê</button>
                    <h1 style="font-size: 22px;">Progress Report</h1>
                </div>
                <div class="container">
                    <div class="card">
                        <h2 style="font-size: 20px; margin-bottom: 4px;">${latest.name}</h2>
                        <p style="font-size: 14px; color: #94a3b8; margin-bottom: 20px;">${latest.sport} ‚Ä¢ ${latest.age} years</p>
                        
                        <div class="grid-3" style="margin-bottom: 20px;">
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: 900; color: #94a3b8;">${oldest.total}</div>
                                <div style="font-size: 11px; color: #64748b;">First Test</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: 900; color: ${improvement >= 0 ? '#10b981' : '#ef4444'};">
                                    ${improvement >= 0 ? '+' : ''}${improvement}
                                </div>
                                <div style="font-size: 11px; color: #64748b;">Change</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: 900; color: ${getRating(latest.total).color};">${latest.total}</div>
                                <div style="font-size: 11px; color: #64748b;">Latest</div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h3 style="font-size: 16px; margin-bottom: 16px;">üìä All Tests (${history.length})</h3>
                        ${history.slice().reverse().map((test, idx) => {
                            const prev = idx < history.length - 1 ? history[history.length - 2 - idx] : null;
                            const diff = prev ? test.total - prev.total : 0;
                            const { color, emoji } = getRating(test.total);
                            
                            return `
                                <div class="comparison-card">
                                    <div class="comparison-header">
                                        <div>
                                            <div class="comparison-date">
                                                ${new Date(test.timestamp).toLocaleDateString('en-IN')} ‚Ä¢ 
                                                ${new Date(test.timestamp).toLocaleTimeString('en-IN', {hour: '2-digit', minute: '2-digit'})}
                                            </div>
                                        </div>
                                        <div style="text-align: right;">
                                            <div class="comparison-score" style="color: ${color};">${test.total}</div>
                                            ${prev ? `
                                                <div style="font-size: 12px; font-weight: 700; ${diff > 0 ? 'color: #10b981' : diff < 0 ? 'color: #ef4444' : 'color: #94a3b8'}">
                                                    ${diff > 0 ? '‚Üó' : diff < 0 ? '‚Üò' : '‚Üí'} ${diff >= 0 ? '+' : ''}${diff}
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                    ${test.scores.map(s => `
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 13px;">
                                            <span style="color: #94a3b8;">${s.icon} ${s.name}</span>
                                            <span style="color: #f1f5f9; font-weight: 600;">${s.raw} ${s.unit}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            `;
                        }).join('')}
                    </div>

                    <button class="btn" id="new-test-same-btn">Test ${latest.name} Again</button>
                </div>
            `;
        }

        // Event listeners
        function attachEventListeners() {
            // Welcome
            const checkPhoneBtn = document.getElementById('check-phone-btn');
            if (checkPhoneBtn) {
                checkPhoneBtn.onclick = () => {
                    const phone = document.getElementById('coach-phone').value.trim();
                    const name = document.getElementById('coach-name').value.trim();
                    
                    if (!phone || phone.length !== 10) {
                        alert('Please enter valid 10-digit mobile number');
                        return;
                    }

                    const allCoaches = JSON.parse(localStorage.getItem('talentScout_allCoaches') || '{}');
                    const existingCoach = allCoaches[phone];

                    if (existingCoach) {
                        saveCoach(existingCoach);
                        const savedAthletes = localStorage.getItem(`talentScout_athletes_${phone}`);
                        if (savedAthletes) state.athletes = JSON.parse(savedAthletes);
                        state.view = 'home';
                        render();
                    } else {
                        state.setupForm = { name, phone, school: '', district: '', state: '' };
                        state.view = 'login';
                        render();
                    }
                };
            }

            const backToWelcomeBtn = document.getElementById('back-to-welcome-btn');
            if (backToWelcomeBtn) {
                backToWelcomeBtn.onclick = () => {
                    state.view = 'welcome';
                    render();
                };
            }

            const setupBtn = document.getElementById('setup-btn');
            if (setupBtn) {
                setupBtn.onclick = () => {
                    const name = document.getElementById('coach-name').value.trim();
                    const phone = state.setupForm.phone;
                    const school = document.getElementById('coach-school').value.trim();
                    const district = document.getElementById('coach-district').value.trim();
                    const stateValue = document.getElementById('coach-state').value;
                    
                    if (!name || !school || !district || !stateValue) {
                        alert('Please fill all fields');
                        return;
                    }

                    const coach = {
                        id: Date.now(),
                        name, phone, school, district, state: stateValue,
                        createdAt: new Date().toISOString()
                    };
                    saveCoach(coach);
                    state.view = 'home';
                    render();
                };
            }

            // Home
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.onclick = () => {
                    if (confirm('Logout? Data stays saved. Login with your phone anytime.')) {
                        localStorage.removeItem('talentScout_coach');
                        state.coach = null;
                        state.athletes = [];
                        state.view = 'welcome';
                        render();
                    }
                };
            }

            const newAssessmentBtn = document.getElementById('new-assessment-btn');
            if (newAssessmentBtn) {
                newAssessmentBtn.onclick = () => {
                    state.form = { name: '', age: '12', sport: 'Track Athlete', values: {} };
                    state.view = 'assess';
                    render();
                };
            }

            const viewAllBtn = document.getElementById('view-all-btn');
            if (viewAllBtn) {
                viewAllBtn.onclick = () => {
                    state.view = 'list';
                    render();
                };
            }

            const exportBtn = document.getElementById('export-btn');
            if (exportBtn) exportBtn.onclick = exportCSV;

            // Assess
            const backBtn = document.getElementById('back-btn');
            if (backBtn) {
                backBtn.onclick = () => {
                    state.view = state.athletes.length > 0 ? 'home' : 'welcome';
                    render();
                };
            }

            const sportOptions = document.querySelectorAll('.sport-option');
            sportOptions.forEach(opt => {
                opt.onclick = () => {
                    state.form.sport = opt.getAttribute('data-sport');
                    state.form.values = {};
                    render();
                };
            });

            const ageSelect = document.getElementById('athlete-age');
            if (ageSelect) {
                ageSelect.onchange = (e) => {
                    state.form.age = e.target.value.replace(' years', '');
                    render();
                };
            }

            const calculateBtn = document.getElementById('calculate-btn');
            if (calculateBtn) {
                calculateBtn.onclick = () => {
                    const name = document.getElementById('athlete-name').value.trim();
                    const age = document.getElementById('athlete-age').value.replace(' years', '');
                    const sport = state.form.sport;
                    
                    const values = {};
                    const sportConfig = SPORTS[sport];
                    const metrics = Object.keys(sportConfig.metrics);
                    
                    let allFilled = true;
                    metrics.forEach(m => {
                        const val = document.getElementById(`metric-${m}`)?.value;
                        if (!val) allFilled = false;
                        values[m] = val;
                    });

                    if (!name || !allFilled) {
                        alert('Please fill all fields');
                        return;
                    }

                    const athleteData = { name, age, sport, values };
                    const result = calcScore(athleteData);
                    
                    const athlete = {
                        ...athleteData,
                        ...result,
                        id: Date.now(),
                        timestamp: new Date().toISOString(),
                        date: new Date().toLocaleDateString('en-IN')
                    };

                    state.athletes.push(athlete);
                    saveAthletes();
                    state.currentAthlete = athlete;
                    state.view = 'result';
                    render();
                };
            }

            // Result
            const viewProgressBtn = document.getElementById('view-progress-btn');
            if (viewProgressBtn) {
                viewProgressBtn.onclick = () => {
                    const a = state.currentAthlete;
                    state.comparisonData = getAthleteHistory(a.name, a.sport);
                    state.view = 'compare';
                    render();
                };
            }

            const newTestBtn = document.getElementById('new-test-btn');
            if (newTestBtn) {
                newTestBtn.onclick = () => {
                    state.form = { name: '', age: '12', sport: 'Track Athlete', values: {} };
                    state.view = 'assess';
                    render();
                };
            }

            const viewAllFromResultBtn = document.getElementById('view-all-from-result-btn');
            if (viewAllFromResultBtn) {
                viewAllFromResultBtn.onclick = () => {
                    state.view = 'list';
                    render();
                };
            }

            // List
            const athleteItems = document.querySelectorAll('.athlete-item');
            athleteItems.forEach(item => {
                item.onclick = () => {
                    const id = parseInt(item.getAttribute('data-id'));
                    state.currentAthlete = state.athletes.find(a => a.id === id);
                    state.view = 'result';
                    render();
                };
            });

            // Compare
            const newTestSameBtn = document.getElementById('new-test-same-btn');
            if (newTestSameBtn) {
                newTestSameBtn.onclick = () => {
                    const latest = state.comparisonData[state.comparisonData.length - 1];
                    state.form = { 
                        name: latest.name, 
                        age: latest.age, 
                        sport: latest.sport, 
                        values: {} 
                    };
                    state.view = 'assess';
                    render();
                };
            }
        }

        // Initialize
        loadData();
        render();
    </script>
</body>
</html>